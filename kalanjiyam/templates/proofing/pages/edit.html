{% extends 'proofing/base.html' %}
{% import "macros/proofing.html" as m %}
{% import "macros/components.html" as mc %}
{% import "proofing/pages/editor-components.html" as editor %}


{# Render a radiobutton as a clickable button. #}
{% macro _status(field, peer_classes) %}
{# Use wrapping div so that we can use the Tailwind "peer" class. #}
<div>
  {{ field(class_="hidden peer") }}
  {{ field.label(class_="block border border-teal-200 rounded-lg p-3 mr-4 text-peacock-primary hover:bg-peacock-light transition-colors " + peer_classes + " peer-checked:font-bold cursor-pointer") }}
</div>
{% endmacro %}


{% block title %}Edit: {{ project.display_title }}/{{ cur.slug }} | Kalanjiyam{% endblock %}


{% block main %}
<article class="p-4">
  {% if not current_user.is_authenticated -%}
  {% set url = url_for('auth.register') %}
  {% call mc.p_warning() %}{% trans %}
  Since you are not logged in, some functions (such as the OCR button) have
  been disabled. To use all website features, please <a class="underline"
  href="{{ url }}">create an account</a>.
  {% endtrans %}{% endcall %}
  {%- endif %}

  {% set num_images = project.pages|length %}
  {{ editor.navigation_bar(page_context, page_number, image_number, num_images) }}
  {{ mc.flash_messages() }}

  {% if conflict %}
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
    <h3 class="text-red-800 font-semibold mb-2">{{ _('Conflict detected') }}</h3>
    <pre class="text-red-700 text-sm">{{ conflict.content }}</pre>
  </div>
  {% endif %}

  <form x-data="proofer" method="POST">
    {{ form.csrf_token }}
    {{ form.version }}

    {% if not has_edits %}
      {# i18n: This should match the "Tools" and "Run OCR" translations in the proofing tool. #}
      {% set command = _("Tools &rarr; Run OCR") %}
      {% call mc.p_note() %}{% trans %}
      This page has not been edited yet. Run <i>{{ command }}</i> to get started.
      {% endtrans %}{% endcall %}
    {% endif %}

    {{ editor.menu_bar() }}
    
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 min-h-[600px]">
      {{ editor.text_box(form.content.data or "") }}
      {{ editor.image_box(translation_content, translation_metadata) }}
    </div>

    <div class="mt-8 bg-white border border-teal-200 rounded-lg p-6 peacock-shadow">
      <div class="mb-6">
        <label class="block text-sm font-medium text-peacock-primary mb-2">{{ form.summary.label.text }}</label>
        {{ form.summary(class_="block rounded-lg bg-white w-full p-3 border border-teal-200 focus:border-peacock-primary focus:ring-2 focus:ring-peacock-light",
            placeholder=_("Fixed various OCR errors")) }}
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-peacock-primary mb-3">{{ form.status.label.text }}</label>
        {% set radios = form.status|list %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          {{ _status(radios[0],
          "peer-checked:bg-red-100 peer-checked:text-red-800 peer-checked:border-red-300") }}
          {{ _status(radios[1],
          "peer-checked:bg-yellow-100 peer-checked:text-yellow-800 peer-checked:border-yellow-300") }}
          {% if not is_r0 %}
          {{ _status(radios[2],
          "peer-checked:bg-emerald-100 peer-checked:text-emerald-800 peer-checked:border-emerald-300") }}
          {% endif %}
          {{ _status(radios[3],
          "peer-checked:bg-slate-100 peer-checked:text-slate-800 peer-checked:border-slate-300") }}
        </div>
      </div>

      {% if current_user.is_authenticated %}
      {% set cc0 = "https://creativecommons.org/publicdomain/zero/1.0/" %}
      <div class="mb-6 p-4 bg-peacock-subtle rounded-lg">
        <p class="text-sm text-peacock-secondary">{% trans %}
        By saving your changes, you agree to release your contribution under the
        <a class="underline" href="{{ cc0 }}">CC0 (public domain) license</a>.
        {% endtrans %}</p>
      </div>

      <div class="flex items-center gap-4">
        <button class="btn btn-submit flex items-center gap-2"
                type="submit"
                @click="hasUnsavedChanges = false">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          {{ _('Publish changes') }}
        </button>
        <span class="text-sm text-peacock-secondary" x-show="hasUnsavedChanges">
          {{ _('You have unsaved changes') }}
        </span>
      </div>
      {% endif %}
    </div>
  </form>

  {% if not current_user.is_authenticated %}
  {% set create = url_for("auth.register") %}
  {% set log_in = url_for("auth.sign_in") %}
  {% call mc.p_warning() %}
  Only registered users can save changes. <a href="{{ create }}">Create an
      account</a> or <a href="{{ log_in }}">sign in</a> to save your
  changes.
  {% endcall %}
  {% endif %}
</article>

<script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1/build/openseadragon/openseadragon.min.js"></script>
{% set image_url = url_for("site.page_image", project_slug=project.slug, page_slug=cur.slug) %}
<script type="text/javascript">
const IMAGE_URL = "{{ image_url }}";
</script>
{% endblock %}
